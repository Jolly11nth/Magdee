import{r as o,u as W,j as e,D as U}from"./index-DhpZogpT.js";import{I}from"./ImageWithFallback-BUzb1kb2.js";import{N as Y}from"./NotificationBell-BjDgmNNL.js";import{c as _}from"./createLucideIcon-BWB-IIpW.js";import{W as $}from"./wifi-off-CTyoMDoP.js";import{A as O}from"./alert-circle-Dk_tpyNt.js";import{H,a as V,U as Q}from"./user-DG0tLWpa.js";const Z=_("Database",[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]]);function oe({onNavigate:d,onSelectBook:v,books:c}){const[u,S]=o.useState("list"),[f,D]=o.useState(""),[B,T]=o.useState("recent"),[h,g]=o.useState([]),[E,F]=o.useState(!1),[k,x]=o.useState(null),[l,w]=o.useState(!0),{user:n}=W(),[a,C]=o.useState(0),[p,A]=o.useState(!1),[m,z]=o.useState(!1),y=o.useRef(null),j=o.useRef(null),R=async(r=!0)=>{if(!n?.id){console.log("No user ID available for loading books");return}r&&F(!0),x(null);try{console.log("🔄 Loading books from database for user:",n.id);const t=await U.getUserBooks(n.id);if(t.success&&t.data){console.log("✅ Successfully loaded books from database:",t.data.length),g(t.data),w(!0);const i=t.data.map(s=>({...s,cover:s.cover_url||s.cover||`https://via.placeholder.com/120x160/4A90E2/ffffff?text=${encodeURIComponent((s.title||"Book").substring(0,2))}`,duration:s.duration||"00:00",genre:s.genre||s.category||"Unknown",progress:typeof s.progress=="number"?s.progress:0,rating:s.rating||0}));g(i)}else console.warn("❌ Failed to load books from database:",t.error),x(t.error||"Failed to load books from database"),w(!1),h.length===0&&c&&c.length>0&&(console.log("📚 Falling back to props books as backup"),g(c))}catch(t){console.error("💥 Error loading books from database:",t);const i=t instanceof Error?t.message:"Unknown error occurred";x(i),w(!1),h.length===0&&c&&c.length>0&&(console.log("📚 Falling back to props books due to error"),g(c))}finally{r&&F(!1)}},L=r=>{j.current&&j.current.scrollTop===0&&(y.current=r.touches[0].clientY,A(!0))},M=r=>{if(!p||y.current===null||j.current?.scrollTop>0)return;const t=r.touches[0].clientY,i=Math.max(0,t-y.current);i>0&&(r.preventDefault(),C(Math.min(i*.5,80)))},P=async()=>{p&&(A(!1),a>60&&!m?(console.log("🔄 Pull-to-refresh triggered"),z(!0),await R(!1),setTimeout(()=>{z(!1),C(0)},500)):C(0),y.current=null)};o.useEffect(()=>{n?.id?(console.log("👤 User changed, loading books for:",n.id),R()):(console.log("❌ No user available, clearing books"),g([]),x(null))},[n?.id]);const b=[...(h||[]).filter(r=>r.title?.toLowerCase().includes(f.toLowerCase())||r.author?.toLowerCase().includes(f.toLowerCase())||(r.category||r.genre||"").toLowerCase().includes(f.toLowerCase()))].sort((r,t)=>{switch(B){case"title":return(r.title||"").localeCompare(t.title||"");case"author":return(r.author||"").localeCompare(t.author||"");case"progress":return(t.progress||0)-(r.progress||0);default:const i=new Date(r.converted_at||r.updated_at||r.created_at||0).getTime();return new Date(t.converted_at||t.updated_at||t.created_at||0).getTime()-i}});return e.jsxs("div",{style:{width:"100%",height:"100%",backgroundColor:"#ffffff",display:"flex",flexDirection:"column",fontFamily:"Poppins, sans-serif",position:"relative",overflow:"hidden"},children:[(p||m)&&e.jsx("div",{style:{position:"absolute",top:Math.max(-40+a*.5,-40),left:"50%",transform:"translateX(-50%)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center",width:"40px",height:"40px",backgroundColor:"#4A90E2",borderRadius:"50%",boxShadow:"0 4px 12px rgba(74, 144, 226, 0.3)",opacity:m?1:Math.min(a/60,1),transition:m?"top 0.3s ease":"none"},children:e.jsx("div",{style:{width:"20px",height:"20px",border:"2px solid rgba(255, 255, 255, 0.3)",borderTop:"2px solid white",borderRadius:"50%",animation:m||a>60?"spin 1s linear infinite":"none"}})}),e.jsxs("div",{style:{padding:"1rem 1.5rem",borderBottom:"1px solid #F3F4F6",transform:`translateY(${Math.min(a*.3,25)}px)`,transition:p?"none":"transform 0.3s ease"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"1rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[e.jsx("button",{onClick:()=>d("back"),style:{backgroundColor:"transparent",border:"none",fontSize:"1.5rem",cursor:"pointer",marginRight:"1rem",color:"#374151"},children:"←"}),e.jsx("h2",{style:{fontSize:"1.125rem",fontWeight:"600",color:"#374151",margin:0},children:"My Library"})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(Y,{onNavigate:d}),e.jsxs("div",{style:{display:"flex",alignItems:"center",padding:"0.25rem 0.5rem",borderRadius:"0.5rem",backgroundColor:l?"rgba(16, 185, 129, 0.1)":"rgba(239, 68, 68, 0.1)",color:l?"#10B981":"#EF4444",fontSize:"0.75rem"},children:[l?e.jsx(Z,{size:12}):e.jsx($,{size:12}),e.jsx("span",{style:{marginLeft:"0.25rem"},children:l?"DB":"Offline"})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsx("button",{onClick:()=>S("list"),style:{padding:"0.5rem",border:"none",borderRadius:"0.5rem",cursor:"pointer",backgroundColor:u==="list"?"#4A90E2":"#F3F4F6",color:u==="list"?"white":"#6B7280",fontSize:"1rem"},children:"☰"}),e.jsx("button",{onClick:()=>S("grid"),style:{padding:"0.5rem",border:"none",borderRadius:"0.5rem",cursor:"pointer",backgroundColor:u==="grid"?"#4A90E2":"#F3F4F6",color:u==="grid"?"white":"#6B7280",fontSize:"1rem"},children:"⊞"})]})]})]}),e.jsxs("div",{style:{position:"relative",marginBottom:"1rem"},children:[e.jsx("input",{placeholder:"Search books, authors, or categories...",value:f,onChange:r=>D(r.target.value),style:{width:"100%",padding:"0.75rem 0.75rem 0.75rem 2.5rem",backgroundColor:"#F9FAFB",border:"1px solid #E5E7EB",borderRadius:"0.75rem",fontSize:"1rem",fontFamily:"Poppins, sans-serif"}}),e.jsx("span",{style:{position:"absolute",left:"0.75rem",top:"50%",transform:"translateY(-50%)",color:"#9CA3AF",fontSize:"1.25rem"},children:"🔍"})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("select",{value:B,onChange:r=>T(r.target.value),style:{padding:"0.5rem",backgroundColor:"#F9FAFB",border:"1px solid #E5E7EB",borderRadius:"0.5rem",fontSize:"0.875rem",fontFamily:"Poppins, sans-serif"},children:[e.jsx("option",{value:"recent",children:"Most Recent"}),e.jsx("option",{value:"title",children:"Title A-Z"}),e.jsx("option",{value:"author",children:"Author A-Z"}),e.jsx("option",{value:"progress",children:"Progress"})]}),e.jsx("button",{onClick:()=>d("upload"),style:{backgroundColor:"#4A90E2",color:"white",border:"none",borderRadius:"0.5rem",padding:"0.5rem 1rem",fontSize:"0.875rem",fontWeight:"600",cursor:"pointer",fontFamily:"Poppins, sans-serif"},children:"+ Add Book"})]})]}),e.jsxs("div",{ref:j,onTouchStart:L,onTouchMove:M,onTouchEnd:P,style:{flex:1,overflowY:"auto",padding:"1rem 1.5rem",paddingBottom:"5rem",transform:`translateY(${Math.min(a*.3,25)}px)`,transition:p?"none":"transform 0.3s ease",WebkitOverflowScrolling:"touch"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"1rem"},children:[e.jsxs("p",{style:{color:"#6B7280",fontSize:"0.875rem",margin:0},children:[E||m?"Loading...":`${b.length} books found`,h.length>0&&l&&e.jsx("span",{style:{marginLeft:"0.5rem",color:"#10B981"},children:"• From database"}),!l&&h.length>0&&e.jsx("span",{style:{marginLeft:"0.5rem",color:"#F59E0B"},children:"• Cached data"}),p&&a>60&&e.jsx("span",{style:{marginLeft:"0.5rem",color:"#4A90E2"},children:"• Release to refresh"})]}),k&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.25rem",color:"#EF4444",fontSize:"0.75rem"},children:[e.jsx(O,{size:14}),e.jsx("span",{children:k})]})]}),b.length===0?e.jsxs("div",{style:{textAlign:"center",padding:"3rem 1rem",color:"#6B7280"},children:[e.jsx("div",{style:{fontSize:"3rem",marginBottom:"1rem"},children:"📚"}),e.jsx("p",{style:{fontSize:"1rem",fontWeight:"500"},children:n?"No books found":"Please sign in to view your library"}),e.jsx("p",{style:{fontSize:"0.875rem"},children:n?E?"Loading your books...":"Try adjusting your search or upload a new book":"Your books will appear here after signing in"}),e.jsx("p",{style:{fontSize:"0.75rem",marginTop:"1rem",color:"#9CA3AF"},children:"💡 Pull down to refresh your library"}),!l&&e.jsx("p",{style:{fontSize:"0.75rem",marginTop:"0.5rem",color:"#F59E0B"},children:"📡 Server offline - showing cached data"})]}):u==="list"?e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"0.75rem"},children:b.map(r=>e.jsxs("div",{onClick:()=>v(r),style:{display:"flex",alignItems:"center",padding:"1rem",backgroundColor:"#F9FAFB",borderRadius:"0.75rem",cursor:"pointer",border:"1px solid #E5E7EB",transition:"all 0.2s ease"},children:[e.jsxs("div",{style:{width:"56px",height:"56px",backgroundColor:"#4A90E2",borderRadius:"10px",display:"flex",alignItems:"center",justifyContent:"center",marginRight:"1rem",fontSize:"1.5rem",position:"relative",overflow:"hidden"},children:[r.cover?e.jsx(I,{src:r.cover,alt:r.title||"Book",style:{width:"100%",height:"100%",objectFit:"cover"}}):e.jsx("span",{style:{color:"white"},children:"📖"}),r.progress===100&&e.jsx("div",{style:{position:"absolute",top:"-4px",right:"-4px",width:"20px",height:"20px",backgroundColor:"#10B981",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.75rem"},children:"✓"})]}),e.jsxs("div",{style:{flex:1},children:[e.jsx("h4",{style:{color:"#374151",fontWeight:"600",margin:"0 0 0.25rem 0",fontSize:"1rem"},children:r.title||"Untitled Book"}),e.jsxs("p",{style:{color:"#6B7280",fontSize:"0.875rem",margin:"0 0 0.5rem 0"},children:[r.author||"Unknown Author"," • ",r.duration||"00:00"]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("div",{style:{flex:1,height:"4px",backgroundColor:"#E5E7EB",borderRadius:"2px",overflow:"hidden"},children:e.jsx("div",{style:{height:"100%",backgroundColor:r.progress===100?"#10B981":"#4A90E2",borderRadius:"2px",width:`${r.progress||0}%`}})}),e.jsxs("span",{style:{color:"#9CA3AF",fontSize:"0.75rem",minWidth:"35px"},children:[r.progress||0,"%"]})]})]}),e.jsx("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem"},children:e.jsx("button",{onClick:t=>{t.stopPropagation(),v(r)},style:{backgroundColor:"#4A90E2",color:"white",border:"none",borderRadius:"50%",width:"36px",height:"36px",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",fontSize:"0.875rem"},children:"▶"})})]},r.id))}):e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"1rem"},children:b.map(r=>e.jsxs("div",{onClick:()=>v(r),style:{backgroundColor:"#F9FAFB",borderRadius:"0.75rem",padding:"1rem",cursor:"pointer",border:"1px solid #E5E7EB",textAlign:"center"},children:[e.jsxs("div",{style:{width:"100%",height:"96px",backgroundColor:"#4A90E2",borderRadius:"10px",display:"flex",alignItems:"center",justifyContent:"center",marginBottom:"0.75rem",fontSize:"2.5rem",position:"relative",overflow:"hidden"},children:[r.cover?e.jsx(I,{src:r.cover,alt:r.title||"Book",style:{width:"100%",height:"100%",objectFit:"cover"}}):e.jsx("span",{style:{color:"white"},children:"📖"}),r.progress===100&&e.jsx("div",{style:{position:"absolute",top:"8px",right:"8px",width:"24px",height:"24px",backgroundColor:"#10B981",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.875rem"},children:"✓"})]}),e.jsx("h4",{style:{color:"#374151",fontWeight:"600",fontSize:"0.875rem",margin:"0 0 0.25rem 0",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:r.title||"Untitled Book"}),e.jsx("p",{style:{color:"#6B7280",fontSize:"0.75rem",margin:"0 0 0.5rem 0",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:r.author||"Unknown Author"}),e.jsx("div",{style:{width:"100%",height:"4px",backgroundColor:"#E5E7EB",borderRadius:"2px",overflow:"hidden",marginBottom:"0.5rem"},children:e.jsx("div",{style:{height:"100%",backgroundColor:r.progress===100?"#10B981":"#4A90E2",borderRadius:"2px",width:`${r.progress||0}%`}})}),e.jsxs("span",{style:{color:"#9CA3AF",fontSize:"0.75rem"},children:[r.progress||0,"% • ",r.duration||"00:00"]})]},r.id))})]}),e.jsxs("div",{style:{position:"absolute",bottom:"1.25rem",left:"1.25rem",right:"1.25rem",backgroundColor:"#E3F2FD",borderRadius:"15px",padding:"0 1rem",display:"flex",justifyContent:"space-around",alignItems:"center"},children:[e.jsxs("button",{onClick:()=>d("home"),style:{display:"flex",flexDirection:"column",alignItems:"center",gap:"0.25rem",background:"none",border:"none",cursor:"pointer",padding:"0.5rem",color:"#6B7280"},children:[e.jsx(H,{size:24}),e.jsx("span",{style:{fontSize:"0.8rem",fontWeight:"500"},children:"Home"})]}),e.jsxs("button",{onClick:()=>d("library"),style:{display:"flex",flexDirection:"column",alignItems:"center",gap:"0.25rem",background:"none",border:"none",cursor:"pointer",padding:"0.5rem",color:"#4A90E2"},children:[e.jsx(V,{size:24}),e.jsx("span",{style:{fontSize:"0.8rem",fontWeight:"500"},children:"Audio books"})]}),e.jsxs("button",{onClick:()=>d("profile"),style:{display:"flex",flexDirection:"column",alignItems:"center",gap:"0.25rem",background:"none",border:"none",cursor:"pointer",padding:"0.5rem",color:"#6B7280"},children:[e.jsx(Q,{size:24}),e.jsx("span",{style:{fontSize:"0.8rem",fontWeight:"500"},children:"Profile"})]})]})]})}export{oe as MyLibraryScreen};
